#!/bin/bash

set -e -x

# Install git-lfs
cd /tmp
wget https://github.com/git-lfs/git-lfs/releases/download/v2.7.2/git-lfs-linux-386-v2.7.2.tar.gz
mkdir -p git-lfs
cd git-lfs
tar xzf ../git-lfs-linux-386-v2.7.2.tar.gz
sudo ./install.sh

# Install cimr
cd ~/cimr/
git checkout crossmap  # switch to "crossmap" branch

git lfs install && git lfs pull
python3 setup.py build
sudo python3 setup.py install

# Remove intermediate files generated by the build/install commands
sudo rm -rf ./build/ ./cimr.egg-info/ ./dist/

# Test examples
cd examples/

# Process yaml examples
for DATATYPE in "eqtl" "gwas"; do
    cimr processor -process -yaml-file submitted/${DATATYPE}.yml

    OUTPUT_PREFIX=${DATATYPE}/${DATATYPE}
    gunzip -k processed_data/${OUTPUT_PREFIX}.txt.gz

    # Verify output result
    gunzip -k expected_processed_data/${DATATYPE}/${DATATYPE}.txt.gz
    diff processed_data/${OUTPUT_PREFIX}.txt expected_processed_data/${OUTPUT_PREFIX}.txt

    # Clear up "submitted_data" and "processed_data"
    rm -rf submitted_data processed_data
done

# Verify catalog file
diff cimr-d_catalog.txt expected_cimr-d_catalog.txt
