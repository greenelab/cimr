version: 2.1
jobs:
  test:
    docker:
      - image: circleci/python:3.6.8
    working_directory: ~/cimr
    resource_class: xlarge
    steps:
      - checkout
      - run:
          name: Install cimr
          command: bash .circleci/install_cimr.sh
      - run:
          name: Parallel Test - SMALL gwas, default chunksize (5m)
          working_directory: ~/cimr/.circleci/dhu_test/small_gwas
          command: |
            rm -rf submitted_data/ processed_data/ catalog.txt
            cimr processor -process -yaml-file small_gwas.yml
            gunzip -k processed_data/gwas/gwas.txt.gz
            md5sum --check md5.txt
      - run:
          name: Parallel Test - SMALL gwas, chunksize 500
          working_directory: ~/cimr/.circleci/dhu_test/small_gwas
          command: |
            rm -rf submitted_data/ processed_data/ catalog.txt
            cimr processor -process -yaml-file small_gwas.yml -chunksize 500
            gunzip -k processed_data/gwas/gwas.txt.gz
            md5sum --check md5.txt
      - run:
          name: Parallel Test - BIG gwas, chunksize 1m
          working_directory: ~/cimr/.circleci/dhu_test/big_gwas
          command: |
            rm -rf submitted_data/ processed_data/ catalog.txt
            cimr processor -process -yaml-file big_gwas.yml -chunksize 1000000
            gunzip -k processed_data/gwas/PheCode_187.2_SAIGE_*.gz
            md5sum --check md5.txt
      - run:
          name: Parallel Test - BIG gwas, default chunksize (5m)
          working_directory: ~/cimr/.circleci/dhu_test/big_gwas
          command: |
            rm -rf submitted_data/ processed_data/ catalog.txt
            cimr processor -process -yaml-file big_gwas.yml
            gunzip -k processed_data/gwas/PheCode_187.2_SAIGE_*.gz
            md5sum --check md5.txt

workflows:
  version: 2
  test:
    jobs:
      - test
